function cov_17wvd6gqhp(){var path="/Users/federicolacabaratz/bootcamp/collab/skylab-bootcamp-202001/staff/federico-lacabaratz/share-my-spot/share-my-spot-api/logic/update-user.js";var hash="921a9d8065eacf68123641e19e9a3588178df59e";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/Users/federicolacabaratz/bootcamp/collab/skylab-bootcamp-202001/staff/federico-lacabaratz/share-my-spot/share-my-spot-api/logic/update-user.js",statementMap:{"0":{start:{line:1,column:21},end:{line:1,column:57}},"1":{start:{line:2,column:29},end:{line:2,column:64}},"2":{start:{line:3,column:43},end:{line:3,column:80}},"3":{start:{line:4,column:15},end:{line:4,column:34}},"4":{start:{line:21,column:0},end:{line:82,column:1}},"5":{start:{line:22,column:51},end:{line:22,column:55}},"6":{start:{line:27,column:4},end:{line:27,column:37}},"7":{start:{line:28,column:4},end:{line:32,column:5}},"8":{start:{line:29,column:8},end:{line:29,column:39}},"9":{start:{line:30,column:8},end:{line:30,column:29}},"10":{start:{line:31,column:8},end:{line:31,column:22}},"11":{start:{line:33,column:4},end:{line:36,column:5}},"12":{start:{line:34,column:8},end:{line:34,column:45}},"13":{start:{line:35,column:8},end:{line:35,column:22}},"14":{start:{line:37,column:4},end:{line:40,column:5}},"15":{start:{line:38,column:8},end:{line:38,column:51}},"16":{start:{line:39,column:8},end:{line:39,column:45}},"17":{start:{line:42,column:4},end:{line:81,column:23}},"18":{start:{line:44,column:12},end:{line:44,column:85}},"19":{start:{line:44,column:27},end:{line:44,column:85}},"20":{start:{line:45,column:12},end:{line:45,column:40}},"21":{start:{line:48,column:12},end:{line:50,column:13}},"22":{start:{line:49,column:16},end:{line:49,column:35}},"23":{start:{line:51,column:12},end:{line:53,column:13}},"24":{start:{line:52,column:16},end:{line:52,column:35}},"25":{start:{line:54,column:12},end:{line:61,column:13}},"26":{start:{line:55,column:16},end:{line:57,column:17}},"27":{start:{line:56,column:20},end:{line:56,column:69}},"28":{start:{line:58,column:16},end:{line:58,column:22}},"29":{start:{line:60,column:16},end:{line:60,column:75}},"30":{start:{line:64,column:12},end:{line:67,column:13}},"31":{start:{line:65,column:16},end:{line:65,column:48}},"32":{start:{line:67,column:13},end:{line:71,column:13}},"33":{start:{line:68,column:16},end:{line:68,column:67}},"34":{start:{line:70,column:16},end:{line:70,column:22}},"35":{start:{line:74,column:12},end:{line:79,column:13}},"36":{start:{line:75,column:16},end:{line:75,column:116}},"37":{start:{line:78,column:16},end:{line:78,column:154}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:21,column:17},end:{line:21,column:18}},loc:{start:{line:21,column:35},end:{line:82,column:1}},line:21},"1":{name:"(anonymous_1)",decl:{start:{line:43,column:14},end:{line:43,column:15}},loc:{start:{line:43,column:26},end:{line:46,column:9}},line:43},"2":{name:"(anonymous_2)",decl:{start:{line:47,column:14},end:{line:47,column:15}},loc:{start:{line:47,column:22},end:{line:62,column:9}},line:47},"3":{name:"(anonymous_3)",decl:{start:{line:63,column:14},end:{line:63,column:15}},loc:{start:{line:63,column:27},end:{line:72,column:9}},line:63},"4":{name:"(anonymous_4)",decl:{start:{line:73,column:14},end:{line:73,column:15}},loc:{start:{line:73,column:27},end:{line:80,column:9}},line:73},"5":{name:"(anonymous_5)",decl:{start:{line:81,column:14},end:{line:81,column:15}},loc:{start:{line:81,column:20},end:{line:81,column:22}},line:81}},branchMap:{"0":{loc:{start:{line:28,column:4},end:{line:32,column:5}},type:"if",locations:[{start:{line:28,column:4},end:{line:32,column:5}},{start:{line:28,column:4},end:{line:32,column:5}}],line:28},"1":{loc:{start:{line:33,column:4},end:{line:36,column:5}},type:"if",locations:[{start:{line:33,column:4},end:{line:36,column:5}},{start:{line:33,column:4},end:{line:36,column:5}}],line:33},"2":{loc:{start:{line:37,column:4},end:{line:40,column:5}},type:"if",locations:[{start:{line:37,column:4},end:{line:40,column:5}},{start:{line:37,column:4},end:{line:40,column:5}}],line:37},"3":{loc:{start:{line:37,column:8},end:{line:37,column:31}},type:"binary-expr",locations:[{start:{line:37,column:8},end:{line:37,column:19}},{start:{line:37,column:23},end:{line:37,column:31}}],line:37},"4":{loc:{start:{line:44,column:12},end:{line:44,column:85}},type:"if",locations:[{start:{line:44,column:12},end:{line:44,column:85}},{start:{line:44,column:12},end:{line:44,column:85}}],line:44},"5":{loc:{start:{line:48,column:12},end:{line:50,column:13}},type:"if",locations:[{start:{line:48,column:12},end:{line:50,column:13}},{start:{line:48,column:12},end:{line:50,column:13}}],line:48},"6":{loc:{start:{line:51,column:12},end:{line:53,column:13}},type:"if",locations:[{start:{line:51,column:12},end:{line:53,column:13}},{start:{line:51,column:12},end:{line:53,column:13}}],line:51},"7":{loc:{start:{line:54,column:12},end:{line:61,column:13}},type:"if",locations:[{start:{line:54,column:12},end:{line:61,column:13}},{start:{line:54,column:12},end:{line:61,column:13}}],line:54},"8":{loc:{start:{line:55,column:16},end:{line:57,column:17}},type:"if",locations:[{start:{line:55,column:16},end:{line:57,column:17}},{start:{line:55,column:16},end:{line:57,column:17}}],line:55},"9":{loc:{start:{line:64,column:12},end:{line:67,column:13}},type:"if",locations:[{start:{line:64,column:12},end:{line:67,column:13}},{start:{line:64,column:12},end:{line:67,column:13}}],line:64},"10":{loc:{start:{line:64,column:16},end:{line:64,column:38}},type:"binary-expr",locations:[{start:{line:64,column:16},end:{line:64,column:23}},{start:{line:64,column:27},end:{line:64,column:38}}],line:64},"11":{loc:{start:{line:67,column:13},end:{line:71,column:13}},type:"if",locations:[{start:{line:67,column:13},end:{line:71,column:13}},{start:{line:67,column:13},end:{line:71,column:13}}],line:67},"12":{loc:{start:{line:74,column:12},end:{line:79,column:13}},type:"if",locations:[{start:{line:74,column:12},end:{line:79,column:13}},{start:{line:74,column:12},end:{line:79,column:13}}],line:74}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0],"12":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"921a9d8065eacf68123641e19e9a3588178df59e"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];cov_17wvd6gqhp=function(){return actualCoverage;};return actualCoverage;}cov_17wvd6gqhp();const{validate}=(cov_17wvd6gqhp().s[0]++,require('../../share-my-spot-utils'));const{models:{User}}=(cov_17wvd6gqhp().s[1]++,require('../../share-my-spot-data'));const{NotFoundError,NotAllowedError}=(cov_17wvd6gqhp().s[2]++,require('../../share-my-spot-errors'));const bcrypt=(cov_17wvd6gqhp().s[3]++,require('bcryptjs'));/**
 * Updates the user's info
 * 
 * @param {string} userId user's unique id
 * @param {object} body the elements that will be updated
 * @param {string} email user's unique e-mail
 * @param {number} phone user's unique phone number
 * @param {string} oldPassword user's oldPassword (required to update to a new one)
 * @param {string} password user's password
 * 
 * @returns {Promise<string>} an empty Promise on a successful update
 * 
 * @throws {NotAllowedError} if a user set a wrong password
 */cov_17wvd6gqhp().s[4]++;module.exports=(userId,body)=>{cov_17wvd6gqhp().f[0]++;const{email,phone,oldPassword,password}=(cov_17wvd6gqhp().s[5]++,body);let email_;let phone_;cov_17wvd6gqhp().s[6]++;validate.string(userId,'userId');cov_17wvd6gqhp().s[7]++;if(email){cov_17wvd6gqhp().b[0][0]++;cov_17wvd6gqhp().s[8]++;validate.string(email,'email');cov_17wvd6gqhp().s[9]++;validate.email(email);cov_17wvd6gqhp().s[10]++;email_=email;}else{cov_17wvd6gqhp().b[0][1]++;}cov_17wvd6gqhp().s[11]++;if(phone){cov_17wvd6gqhp().b[1][0]++;cov_17wvd6gqhp().s[12]++;validate.type(phone,'phone',Number);cov_17wvd6gqhp().s[13]++;phone_=phone;}else{cov_17wvd6gqhp().b[1][1]++;}cov_17wvd6gqhp().s[14]++;if((cov_17wvd6gqhp().b[3][0]++,oldPassword)&&(cov_17wvd6gqhp().b[3][1]++,password)){cov_17wvd6gqhp().b[2][0]++;cov_17wvd6gqhp().s[15]++;validate.string(oldPassword,'oldPassword');cov_17wvd6gqhp().s[16]++;validate.string(password,'password');}else{cov_17wvd6gqhp().b[2][1]++;}cov_17wvd6gqhp().s[17]++;return User.findOne({email}).then(incorrect=>{cov_17wvd6gqhp().f[1]++;cov_17wvd6gqhp().s[18]++;if(incorrect){cov_17wvd6gqhp().b[4][0]++;cov_17wvd6gqhp().s[19]++;throw new NotAllowedError('This email is already in use.');}else{cov_17wvd6gqhp().b[4][1]++;}cov_17wvd6gqhp().s[20]++;return User.findById(userId);}).then(user=>{cov_17wvd6gqhp().f[2]++;cov_17wvd6gqhp().s[21]++;if(!email){cov_17wvd6gqhp().b[5][0]++;cov_17wvd6gqhp().s[22]++;email_=user.email;}else{cov_17wvd6gqhp().b[5][1]++;}cov_17wvd6gqhp().s[23]++;if(!phone){cov_17wvd6gqhp().b[6][0]++;cov_17wvd6gqhp().s[24]++;phone_=user.phone;}else{cov_17wvd6gqhp().b[6][1]++;}cov_17wvd6gqhp().s[25]++;if(user){cov_17wvd6gqhp().b[7][0]++;cov_17wvd6gqhp().s[26]++;if(oldPassword){cov_17wvd6gqhp().b[8][0]++;cov_17wvd6gqhp().s[27]++;return bcrypt.compare(oldPassword,user.password);}else{cov_17wvd6gqhp().b[8][1]++;}cov_17wvd6gqhp().s[28]++;return;}else{cov_17wvd6gqhp().b[7][1]++;cov_17wvd6gqhp().s[29]++;throw new NotFoundError('This user cannot change the data');}}).then(correct=>{cov_17wvd6gqhp().f[3]++;cov_17wvd6gqhp().s[30]++;if((cov_17wvd6gqhp().b[10][0]++,correct)&&(cov_17wvd6gqhp().b[10][1]++,oldPassword)){cov_17wvd6gqhp().b[9][0]++;cov_17wvd6gqhp().s[31]++;return bcrypt.hash(password,10);}else{cov_17wvd6gqhp().b[9][1]++;}cov_17wvd6gqhp().s[32]++;if(oldPassword){cov_17wvd6gqhp().b[11][0]++;cov_17wvd6gqhp().s[33]++;throw new NotAllowedError('Old password incorrect');}else{cov_17wvd6gqhp().b[11][1]++;cov_17wvd6gqhp().s[34]++;return;}}).then(nPassword=>{cov_17wvd6gqhp().f[4]++;cov_17wvd6gqhp().s[35]++;if(nPassword){cov_17wvd6gqhp().b[12][0]++;cov_17wvd6gqhp().s[36]++;return User.findByIdAndUpdate(userId,{$set:{email:email_,phone:phone_,password:nPassword}});}else{cov_17wvd6gqhp().b[12][1]++;cov_17wvd6gqhp().s[37]++;return Promise.all([User.findByIdAndUpdate(userId,{$set:{email:email_}}),User.findByIdAndUpdate(userId,{$set:{phone:phone_}})]);}}).then(()=>{cov_17wvd6gqhp().f[5]++;});};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVwZGF0ZS11c2VyLmpzIl0sIm5hbWVzIjpbInZhbGlkYXRlIiwicmVxdWlyZSIsIm1vZGVscyIsIlVzZXIiLCJOb3RGb3VuZEVycm9yIiwiTm90QWxsb3dlZEVycm9yIiwiYmNyeXB0IiwibW9kdWxlIiwiZXhwb3J0cyIsInVzZXJJZCIsImJvZHkiLCJlbWFpbCIsInBob25lIiwib2xkUGFzc3dvcmQiLCJwYXNzd29yZCIsImVtYWlsXyIsInBob25lXyIsInN0cmluZyIsInR5cGUiLCJOdW1iZXIiLCJmaW5kT25lIiwidGhlbiIsImluY29ycmVjdCIsImZpbmRCeUlkIiwidXNlciIsImNvbXBhcmUiLCJjb3JyZWN0IiwiaGFzaCIsIm5QYXNzd29yZCIsImZpbmRCeUlkQW5kVXBkYXRlIiwiJHNldCIsIlByb21pc2UiLCJhbGwiXSwibWFwcGluZ3MiOiJ1c05BQUEsS0FBTSxDQUFFQSxRQUFGLDJCQUFlQyxPQUFPLENBQUMsMkJBQUQsQ0FBdEIsQ0FBTixDQUNBLEtBQU0sQ0FBRUMsTUFBTSxDQUFFLENBQUVDLElBQUYsQ0FBViwyQkFBdUJGLE9BQU8sQ0FBQywwQkFBRCxDQUE5QixDQUFOLENBQ0EsS0FBTSxDQUFFRyxhQUFGLENBQWlCQyxlQUFqQiwyQkFBcUNKLE9BQU8sQ0FBQyw0QkFBRCxDQUE1QyxDQUFOLENBQ0EsS0FBTUssQ0FBQUEsTUFBTSwwQkFBR0wsT0FBTyxDQUFDLFVBQUQsQ0FBVixDQUFaLENBRUE7Ozs7Ozs7Ozs7Ozs7MkJBZUFNLE1BQU0sQ0FBQ0MsT0FBUCxDQUFpQixDQUFDQyxNQUFELENBQVNDLElBQVQsR0FBa0IseUJBQy9CLEtBQU0sQ0FBQ0MsS0FBRCxDQUFRQyxLQUFSLENBQWVDLFdBQWYsQ0FBNEJDLFFBQTVCLDJCQUF5Q0osSUFBekMsQ0FBTixDQUVBLEdBQUlLLENBQUFBLE1BQUosQ0FDQSxHQUFJQyxDQUFBQSxNQUFKLENBSitCLHdCQU0vQmhCLFFBQVEsQ0FBQ2lCLE1BQVQsQ0FBZ0JSLE1BQWhCLENBQXdCLFFBQXhCLEVBTitCLHdCQU8vQixHQUFJRSxLQUFKLENBQVUsb0RBQ05YLFFBQVEsQ0FBQ2lCLE1BQVQsQ0FBZ0JOLEtBQWhCLENBQXVCLE9BQXZCLEVBRE0sd0JBRU5YLFFBQVEsQ0FBQ1csS0FBVCxDQUFlQSxLQUFmLEVBRk0seUJBR05JLE1BQU0sQ0FBR0osS0FBVCxDQUNILENBSkQsaUNBUCtCLHlCQVkvQixHQUFJQyxLQUFKLENBQVUscURBQ05aLFFBQVEsQ0FBQ2tCLElBQVQsQ0FBY04sS0FBZCxDQUFxQixPQUFyQixDQUE4Qk8sTUFBOUIsRUFETSx5QkFFTkgsTUFBTSxDQUFHSixLQUFULENBQ0gsQ0FIRCxpQ0FaK0IseUJBZ0IvQixHQUFJLDRCQUFBQyxXQUFXLCtCQUFJQyxRQUFKLENBQWYsQ0FBNEIscURBQ3hCZCxRQUFRLENBQUNpQixNQUFULENBQWdCSixXQUFoQixDQUE2QixhQUE3QixFQUR3Qix5QkFFeEJiLFFBQVEsQ0FBQ2lCLE1BQVQsQ0FBZ0JILFFBQWhCLENBQTBCLFVBQTFCLEVBQ0gsQ0FIRCxpQ0FoQitCLHlCQXFCL0IsTUFBT1gsQ0FBQUEsSUFBSSxDQUFDaUIsT0FBTCxDQUFhLENBQUNULEtBQUQsQ0FBYixFQUNGVSxJQURFLENBQ0dDLFNBQVMsRUFBRyxrREFDZCxHQUFJQSxTQUFKLENBQWUsMERBQU0sSUFBSWpCLENBQUFBLGVBQUosQ0FBb0IsK0JBQXBCLENBQU4sQ0FBMEQsQ0FBekUsaUNBRGMseUJBRWQsTUFBT0YsQ0FBQUEsSUFBSSxDQUFDb0IsUUFBTCxDQUFjZCxNQUFkLENBQVAsQ0FDSCxDQUpFLEVBS0ZZLElBTEUsQ0FLR0csSUFBSSxFQUFJLGtEQUNWLEdBQUksQ0FBQ2IsS0FBTCxDQUFXLHFEQUNQSSxNQUFNLENBQUdTLElBQUksQ0FBQ2IsS0FBZCxDQUNILENBRkQsaUNBRFUseUJBSVYsR0FBSSxDQUFDQyxLQUFMLENBQVcscURBQ1BJLE1BQU0sQ0FBR1EsSUFBSSxDQUFDWixLQUFkLENBQ0gsQ0FGRCxpQ0FKVSx5QkFPVixHQUFJWSxJQUFKLENBQVUscURBQ04sR0FBSVgsV0FBSixDQUFnQixxREFDWixNQUFPUCxDQUFBQSxNQUFNLENBQUNtQixPQUFQLENBQWVaLFdBQWYsQ0FBNEJXLElBQUksQ0FBQ1YsUUFBakMsQ0FBUCxDQUNILENBRkQsaUNBRE0seUJBSU4sT0FDSCxDQUxELElBS0sscURBQ0QsS0FBTSxJQUFJVixDQUFBQSxhQUFKLENBQWtCLGtDQUFsQixDQUFOLENBQ0gsQ0FDSixDQXBCRSxFQXFCRmlCLElBckJFLENBcUJJSyxPQUFELEVBQWEsa0RBQ2YsR0FBSSw2QkFBQUEsT0FBTyxnQ0FBSWIsV0FBSixDQUFYLENBQTJCLHFEQUN2QixNQUFPUCxDQUFBQSxNQUFNLENBQUNxQixJQUFQLENBQVliLFFBQVosQ0FBc0IsRUFBdEIsQ0FBUCxDQUVILENBSEQsaUNBRGUseUJBSWQsR0FBSUQsV0FBSixDQUFnQixzREFDYixLQUFNLElBQUlSLENBQUFBLGVBQUosQ0FBb0Isd0JBQXBCLENBQU4sQ0FDSCxDQUZBLElBRUksc0RBQ0QsT0FDSCxDQUNKLENBOUJFLEVBK0JGZ0IsSUEvQkUsQ0ErQkdPLFNBQVMsRUFBSSxrREFDZixHQUFJQSxTQUFKLENBQWMsc0RBQ1YsTUFBT3pCLENBQUFBLElBQUksQ0FBQzBCLGlCQUFMLENBQXVCcEIsTUFBdkIsQ0FBZ0MsQ0FBRXFCLElBQUksQ0FBRSxDQUFDbkIsS0FBSyxDQUFFSSxNQUFSLENBQWdCSCxLQUFLLENBQUVJLE1BQXZCLENBQStCRixRQUFRLENBQUVjLFNBQXpDLENBQVIsQ0FBaEMsQ0FBUCxDQUNILENBRkQsSUFHSSxzREFDQSxNQUFPRyxDQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxDQUFDN0IsSUFBSSxDQUFDMEIsaUJBQUwsQ0FBdUJwQixNQUF2QixDQUFnQyxDQUFFcUIsSUFBSSxDQUFFLENBQUNuQixLQUFLLENBQUVJLE1BQVIsQ0FBUixDQUFoQyxDQUFELENBQTREWixJQUFJLENBQUMwQixpQkFBTCxDQUF1QnBCLE1BQXZCLENBQWdDLENBQUVxQixJQUFJLENBQUUsQ0FBQ2xCLEtBQUssQ0FBRUksTUFBUixDQUFSLENBQWhDLENBQTVELENBQVosQ0FBUCxDQUNILENBQ0osQ0F0Q0UsRUF1Q0ZLLElBdkNFLENBdUNHLElBQU0seUJBQUUsQ0F2Q1gsQ0FBUCxDQXdDSCxDQTdERCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgdmFsaWRhdGUgfSA9IHJlcXVpcmUoJy4uLy4uL3NoYXJlLW15LXNwb3QtdXRpbHMnKVxuY29uc3QgeyBtb2RlbHM6IHsgVXNlciB9IH0gPSByZXF1aXJlKCcuLi8uLi9zaGFyZS1teS1zcG90LWRhdGEnKVxuY29uc3QgeyBOb3RGb3VuZEVycm9yLCBOb3RBbGxvd2VkRXJyb3IgfSA9IHJlcXVpcmUoJy4uLy4uL3NoYXJlLW15LXNwb3QtZXJyb3JzJylcbmNvbnN0IGJjcnlwdCA9IHJlcXVpcmUoJ2JjcnlwdGpzJylcblxuLyoqXG4gKiBVcGRhdGVzIHRoZSB1c2VyJ3MgaW5mb1xuICogXG4gKiBAcGFyYW0ge3N0cmluZ30gdXNlcklkIHVzZXIncyB1bmlxdWUgaWRcbiAqIEBwYXJhbSB7b2JqZWN0fSBib2R5IHRoZSBlbGVtZW50cyB0aGF0IHdpbGwgYmUgdXBkYXRlZFxuICogQHBhcmFtIHtzdHJpbmd9IGVtYWlsIHVzZXIncyB1bmlxdWUgZS1tYWlsXG4gKiBAcGFyYW0ge251bWJlcn0gcGhvbmUgdXNlcidzIHVuaXF1ZSBwaG9uZSBudW1iZXJcbiAqIEBwYXJhbSB7c3RyaW5nfSBvbGRQYXNzd29yZCB1c2VyJ3Mgb2xkUGFzc3dvcmQgKHJlcXVpcmVkIHRvIHVwZGF0ZSB0byBhIG5ldyBvbmUpXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFzc3dvcmQgdXNlcidzIHBhc3N3b3JkXG4gKiBcbiAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz59IGFuIGVtcHR5IFByb21pc2Ugb24gYSBzdWNjZXNzZnVsIHVwZGF0ZVxuICogXG4gKiBAdGhyb3dzIHtOb3RBbGxvd2VkRXJyb3J9IGlmIGEgdXNlciBzZXQgYSB3cm9uZyBwYXNzd29yZFxuICovXG5cbm1vZHVsZS5leHBvcnRzID0gKHVzZXJJZCwgYm9keSkgPT4ge1xuICAgIGNvbnN0IHtlbWFpbCwgcGhvbmUsIG9sZFBhc3N3b3JkLCBwYXNzd29yZH0gPSAgYm9keVxuXG4gICAgbGV0IGVtYWlsX1xuICAgIGxldCBwaG9uZV9cblxuICAgIHZhbGlkYXRlLnN0cmluZyh1c2VySWQsICd1c2VySWQnKVxuICAgIGlmIChlbWFpbCl7XG4gICAgICAgIHZhbGlkYXRlLnN0cmluZyhlbWFpbCwgJ2VtYWlsJylcbiAgICAgICAgdmFsaWRhdGUuZW1haWwoZW1haWwpXG4gICAgICAgIGVtYWlsXyA9IGVtYWlsXG4gICAgfVxuICAgIGlmIChwaG9uZSl7XG4gICAgICAgIHZhbGlkYXRlLnR5cGUocGhvbmUsICdwaG9uZScsIE51bWJlcilcbiAgICAgICAgcGhvbmVfID0gcGhvbmVcbiAgICB9XG4gICAgaWYgKG9sZFBhc3N3b3JkICYmIHBhc3N3b3JkKXtcbiAgICAgICAgdmFsaWRhdGUuc3RyaW5nKG9sZFBhc3N3b3JkLCAnb2xkUGFzc3dvcmQnKVxuICAgICAgICB2YWxpZGF0ZS5zdHJpbmcocGFzc3dvcmQsICdwYXNzd29yZCcpXG4gICAgfVxuXG4gICAgcmV0dXJuIFVzZXIuZmluZE9uZSh7ZW1haWx9KVxuICAgICAgICAudGhlbihpbmNvcnJlY3QgPT57XG4gICAgICAgICAgICBpZiAoaW5jb3JyZWN0KSB0aHJvdyBuZXcgTm90QWxsb3dlZEVycm9yKCdUaGlzIGVtYWlsIGlzIGFscmVhZHkgaW4gdXNlLicpXG4gICAgICAgICAgICByZXR1cm4gVXNlci5maW5kQnlJZCh1c2VySWQpXG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKHVzZXIgPT4ge1xuICAgICAgICAgICAgaWYgKCFlbWFpbCl7XG4gICAgICAgICAgICAgICAgZW1haWxfID0gdXNlci5lbWFpbFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFwaG9uZSl7XG4gICAgICAgICAgICAgICAgcGhvbmVfID0gdXNlci5waG9uZVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgICAgICAgICBpZiAob2xkUGFzc3dvcmQpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmNyeXB0LmNvbXBhcmUob2xkUGFzc3dvcmQsIHVzZXIucGFzc3dvcmQpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ1RoaXMgdXNlciBjYW5ub3QgY2hhbmdlIHRoZSBkYXRhJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oKGNvcnJlY3QpID0+IHtcbiAgICAgICAgICAgIGlmIChjb3JyZWN0ICYmIG9sZFBhc3N3b3JkKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gYmNyeXB0Lmhhc2gocGFzc3dvcmQsIDEwKVxuXG4gICAgICAgICAgICB9aWYgKG9sZFBhc3N3b3JkKXtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTm90QWxsb3dlZEVycm9yKCdPbGQgcGFzc3dvcmQgaW5jb3JyZWN0JylcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfSAgICBcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oblBhc3N3b3JkID0+IHtcbiAgICAgICAgICAgIGlmIChuUGFzc3dvcmQpe1xuICAgICAgICAgICAgICAgIHJldHVybiBVc2VyLmZpbmRCeUlkQW5kVXBkYXRlKHVzZXJJZCAsIHsgJHNldDoge2VtYWlsOiBlbWFpbF8sIHBob25lOiBwaG9uZV8sIHBhc3N3b3JkOiBuUGFzc3dvcmR9fSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtVc2VyLmZpbmRCeUlkQW5kVXBkYXRlKHVzZXJJZCAsIHsgJHNldDoge2VtYWlsOiBlbWFpbF99fSksIFVzZXIuZmluZEJ5SWRBbmRVcGRhdGUodXNlcklkICwgeyAkc2V0OiB7cGhvbmU6IHBob25lX319KV0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKCgpID0+IHt9KVxufSJdfQ==