function cov_17wvd6gqhp(){var path="/Users/federicolacabaratz/bootcamp/collab/skylab-bootcamp-202001/staff/federico-lacabaratz/share-my-spot/share-my-spot-api/logic/update-user.js";var hash="968318e433f86822b6807ad87a4305a93715378b";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/Users/federicolacabaratz/bootcamp/collab/skylab-bootcamp-202001/staff/federico-lacabaratz/share-my-spot/share-my-spot-api/logic/update-user.js",statementMap:{"0":{start:{line:1,column:21},end:{line:1,column:57}},"1":{start:{line:2,column:29},end:{line:2,column:64}},"2":{start:{line:3,column:43},end:{line:3,column:80}},"3":{start:{line:4,column:15},end:{line:4,column:34}},"4":{start:{line:6,column:0},end:{line:67,column:1}},"5":{start:{line:7,column:51},end:{line:7,column:55}},"6":{start:{line:12,column:4},end:{line:12,column:37}},"7":{start:{line:13,column:4},end:{line:17,column:5}},"8":{start:{line:14,column:8},end:{line:14,column:39}},"9":{start:{line:15,column:8},end:{line:15,column:29}},"10":{start:{line:16,column:8},end:{line:16,column:22}},"11":{start:{line:18,column:4},end:{line:21,column:5}},"12":{start:{line:19,column:8},end:{line:19,column:45}},"13":{start:{line:20,column:8},end:{line:20,column:22}},"14":{start:{line:22,column:4},end:{line:25,column:5}},"15":{start:{line:23,column:8},end:{line:23,column:51}},"16":{start:{line:24,column:8},end:{line:24,column:45}},"17":{start:{line:27,column:4},end:{line:66,column:23}},"18":{start:{line:29,column:12},end:{line:29,column:85}},"19":{start:{line:29,column:27},end:{line:29,column:85}},"20":{start:{line:30,column:12},end:{line:30,column:40}},"21":{start:{line:33,column:12},end:{line:35,column:13}},"22":{start:{line:34,column:16},end:{line:34,column:35}},"23":{start:{line:36,column:12},end:{line:38,column:13}},"24":{start:{line:37,column:16},end:{line:37,column:35}},"25":{start:{line:39,column:12},end:{line:46,column:13}},"26":{start:{line:40,column:16},end:{line:42,column:17}},"27":{start:{line:41,column:20},end:{line:41,column:69}},"28":{start:{line:43,column:16},end:{line:43,column:22}},"29":{start:{line:45,column:16},end:{line:45,column:75}},"30":{start:{line:49,column:12},end:{line:52,column:13}},"31":{start:{line:50,column:16},end:{line:50,column:48}},"32":{start:{line:52,column:13},end:{line:56,column:13}},"33":{start:{line:53,column:16},end:{line:53,column:67}},"34":{start:{line:55,column:16},end:{line:55,column:22}},"35":{start:{line:59,column:12},end:{line:64,column:13}},"36":{start:{line:60,column:16},end:{line:60,column:116}},"37":{start:{line:63,column:16},end:{line:63,column:154}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:6,column:17},end:{line:6,column:18}},loc:{start:{line:6,column:35},end:{line:67,column:1}},line:6},"1":{name:"(anonymous_1)",decl:{start:{line:28,column:14},end:{line:28,column:15}},loc:{start:{line:28,column:26},end:{line:31,column:9}},line:28},"2":{name:"(anonymous_2)",decl:{start:{line:32,column:14},end:{line:32,column:15}},loc:{start:{line:32,column:22},end:{line:47,column:9}},line:32},"3":{name:"(anonymous_3)",decl:{start:{line:48,column:14},end:{line:48,column:15}},loc:{start:{line:48,column:27},end:{line:57,column:9}},line:48},"4":{name:"(anonymous_4)",decl:{start:{line:58,column:14},end:{line:58,column:15}},loc:{start:{line:58,column:27},end:{line:65,column:9}},line:58},"5":{name:"(anonymous_5)",decl:{start:{line:66,column:14},end:{line:66,column:15}},loc:{start:{line:66,column:20},end:{line:66,column:22}},line:66}},branchMap:{"0":{loc:{start:{line:13,column:4},end:{line:17,column:5}},type:"if",locations:[{start:{line:13,column:4},end:{line:17,column:5}},{start:{line:13,column:4},end:{line:17,column:5}}],line:13},"1":{loc:{start:{line:18,column:4},end:{line:21,column:5}},type:"if",locations:[{start:{line:18,column:4},end:{line:21,column:5}},{start:{line:18,column:4},end:{line:21,column:5}}],line:18},"2":{loc:{start:{line:22,column:4},end:{line:25,column:5}},type:"if",locations:[{start:{line:22,column:4},end:{line:25,column:5}},{start:{line:22,column:4},end:{line:25,column:5}}],line:22},"3":{loc:{start:{line:22,column:8},end:{line:22,column:31}},type:"binary-expr",locations:[{start:{line:22,column:8},end:{line:22,column:19}},{start:{line:22,column:23},end:{line:22,column:31}}],line:22},"4":{loc:{start:{line:29,column:12},end:{line:29,column:85}},type:"if",locations:[{start:{line:29,column:12},end:{line:29,column:85}},{start:{line:29,column:12},end:{line:29,column:85}}],line:29},"5":{loc:{start:{line:33,column:12},end:{line:35,column:13}},type:"if",locations:[{start:{line:33,column:12},end:{line:35,column:13}},{start:{line:33,column:12},end:{line:35,column:13}}],line:33},"6":{loc:{start:{line:36,column:12},end:{line:38,column:13}},type:"if",locations:[{start:{line:36,column:12},end:{line:38,column:13}},{start:{line:36,column:12},end:{line:38,column:13}}],line:36},"7":{loc:{start:{line:39,column:12},end:{line:46,column:13}},type:"if",locations:[{start:{line:39,column:12},end:{line:46,column:13}},{start:{line:39,column:12},end:{line:46,column:13}}],line:39},"8":{loc:{start:{line:40,column:16},end:{line:42,column:17}},type:"if",locations:[{start:{line:40,column:16},end:{line:42,column:17}},{start:{line:40,column:16},end:{line:42,column:17}}],line:40},"9":{loc:{start:{line:49,column:12},end:{line:52,column:13}},type:"if",locations:[{start:{line:49,column:12},end:{line:52,column:13}},{start:{line:49,column:12},end:{line:52,column:13}}],line:49},"10":{loc:{start:{line:49,column:16},end:{line:49,column:38}},type:"binary-expr",locations:[{start:{line:49,column:16},end:{line:49,column:23}},{start:{line:49,column:27},end:{line:49,column:38}}],line:49},"11":{loc:{start:{line:52,column:13},end:{line:56,column:13}},type:"if",locations:[{start:{line:52,column:13},end:{line:56,column:13}},{start:{line:52,column:13},end:{line:56,column:13}}],line:52},"12":{loc:{start:{line:59,column:12},end:{line:64,column:13}},type:"if",locations:[{start:{line:59,column:12},end:{line:64,column:13}},{start:{line:59,column:12},end:{line:64,column:13}}],line:59}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0],"12":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"968318e433f86822b6807ad87a4305a93715378b"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];cov_17wvd6gqhp=function(){return actualCoverage;};return actualCoverage;}cov_17wvd6gqhp();const{validate}=(cov_17wvd6gqhp().s[0]++,require('../../share-my-spot-utils'));const{models:{User}}=(cov_17wvd6gqhp().s[1]++,require('../../share-my-spot-data'));const{NotFoundError,NotAllowedError}=(cov_17wvd6gqhp().s[2]++,require('../../share-my-spot-errors'));const bcrypt=(cov_17wvd6gqhp().s[3]++,require('bcryptjs'));cov_17wvd6gqhp().s[4]++;module.exports=(userId,body)=>{cov_17wvd6gqhp().f[0]++;const{email,phone,oldPassword,password}=(cov_17wvd6gqhp().s[5]++,body);let email_;let phone_;cov_17wvd6gqhp().s[6]++;validate.string(userId,'userId');cov_17wvd6gqhp().s[7]++;if(email){cov_17wvd6gqhp().b[0][0]++;cov_17wvd6gqhp().s[8]++;validate.string(email,'email');cov_17wvd6gqhp().s[9]++;validate.email(email);cov_17wvd6gqhp().s[10]++;email_=email;}else{cov_17wvd6gqhp().b[0][1]++;}cov_17wvd6gqhp().s[11]++;if(phone){cov_17wvd6gqhp().b[1][0]++;cov_17wvd6gqhp().s[12]++;validate.type(phone,'phone',Number);cov_17wvd6gqhp().s[13]++;phone_=phone;}else{cov_17wvd6gqhp().b[1][1]++;}cov_17wvd6gqhp().s[14]++;if((cov_17wvd6gqhp().b[3][0]++,oldPassword)&&(cov_17wvd6gqhp().b[3][1]++,password)){cov_17wvd6gqhp().b[2][0]++;cov_17wvd6gqhp().s[15]++;validate.string(oldPassword,'oldPassword');cov_17wvd6gqhp().s[16]++;validate.string(password,'password');}else{cov_17wvd6gqhp().b[2][1]++;}cov_17wvd6gqhp().s[17]++;return User.findOne({email}).then(incorrect=>{cov_17wvd6gqhp().f[1]++;cov_17wvd6gqhp().s[18]++;if(incorrect){cov_17wvd6gqhp().b[4][0]++;cov_17wvd6gqhp().s[19]++;throw new NotAllowedError('This email is already in use.');}else{cov_17wvd6gqhp().b[4][1]++;}cov_17wvd6gqhp().s[20]++;return User.findById(userId);}).then(user=>{cov_17wvd6gqhp().f[2]++;cov_17wvd6gqhp().s[21]++;if(!email){cov_17wvd6gqhp().b[5][0]++;cov_17wvd6gqhp().s[22]++;email_=user.email;}else{cov_17wvd6gqhp().b[5][1]++;}cov_17wvd6gqhp().s[23]++;if(!phone){cov_17wvd6gqhp().b[6][0]++;cov_17wvd6gqhp().s[24]++;phone_=user.phone;}else{cov_17wvd6gqhp().b[6][1]++;}cov_17wvd6gqhp().s[25]++;if(user){cov_17wvd6gqhp().b[7][0]++;cov_17wvd6gqhp().s[26]++;if(oldPassword){cov_17wvd6gqhp().b[8][0]++;cov_17wvd6gqhp().s[27]++;return bcrypt.compare(oldPassword,user.password);}else{cov_17wvd6gqhp().b[8][1]++;}cov_17wvd6gqhp().s[28]++;return;}else{cov_17wvd6gqhp().b[7][1]++;cov_17wvd6gqhp().s[29]++;throw new NotFoundError('This user cannot change the data');}}).then(correct=>{cov_17wvd6gqhp().f[3]++;cov_17wvd6gqhp().s[30]++;if((cov_17wvd6gqhp().b[10][0]++,correct)&&(cov_17wvd6gqhp().b[10][1]++,oldPassword)){cov_17wvd6gqhp().b[9][0]++;cov_17wvd6gqhp().s[31]++;return bcrypt.hash(password,10);}else{cov_17wvd6gqhp().b[9][1]++;}cov_17wvd6gqhp().s[32]++;if(oldPassword){cov_17wvd6gqhp().b[11][0]++;cov_17wvd6gqhp().s[33]++;throw new NotAllowedError('Old password incorrect');}else{cov_17wvd6gqhp().b[11][1]++;cov_17wvd6gqhp().s[34]++;return;}}).then(nPassword=>{cov_17wvd6gqhp().f[4]++;cov_17wvd6gqhp().s[35]++;if(nPassword){cov_17wvd6gqhp().b[12][0]++;cov_17wvd6gqhp().s[36]++;return User.findByIdAndUpdate(userId,{$set:{email:email_,phone:phone_,password:nPassword}});}else{cov_17wvd6gqhp().b[12][1]++;cov_17wvd6gqhp().s[37]++;return Promise.all([User.findByIdAndUpdate(userId,{$set:{email:email_}}),User.findByIdAndUpdate(userId,{$set:{phone:phone_}})]);}}).then(()=>{cov_17wvd6gqhp().f[5]++;});};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVwZGF0ZS11c2VyLmpzIl0sIm5hbWVzIjpbInZhbGlkYXRlIiwicmVxdWlyZSIsIm1vZGVscyIsIlVzZXIiLCJOb3RGb3VuZEVycm9yIiwiTm90QWxsb3dlZEVycm9yIiwiYmNyeXB0IiwibW9kdWxlIiwiZXhwb3J0cyIsInVzZXJJZCIsImJvZHkiLCJlbWFpbCIsInBob25lIiwib2xkUGFzc3dvcmQiLCJwYXNzd29yZCIsImVtYWlsXyIsInBob25lXyIsInN0cmluZyIsInR5cGUiLCJOdW1iZXIiLCJmaW5kT25lIiwidGhlbiIsImluY29ycmVjdCIsImZpbmRCeUlkIiwidXNlciIsImNvbXBhcmUiLCJjb3JyZWN0IiwiaGFzaCIsIm5QYXNzd29yZCIsImZpbmRCeUlkQW5kVXBkYXRlIiwiJHNldCIsIlByb21pc2UiLCJhbGwiXSwibWFwcGluZ3MiOiJnc05BQUEsS0FBTSxDQUFFQSxRQUFGLDJCQUFlQyxPQUFPLENBQUMsMkJBQUQsQ0FBdEIsQ0FBTixDQUNBLEtBQU0sQ0FBRUMsTUFBTSxDQUFFLENBQUVDLElBQUYsQ0FBViwyQkFBdUJGLE9BQU8sQ0FBQywwQkFBRCxDQUE5QixDQUFOLENBQ0EsS0FBTSxDQUFFRyxhQUFGLENBQWlCQyxlQUFqQiwyQkFBcUNKLE9BQU8sQ0FBQyw0QkFBRCxDQUE1QyxDQUFOLENBQ0EsS0FBTUssQ0FBQUEsTUFBTSwwQkFBR0wsT0FBTyxDQUFDLFVBQUQsQ0FBVixDQUFaLEMsd0JBRUFNLE1BQU0sQ0FBQ0MsT0FBUCxDQUFpQixDQUFDQyxNQUFELENBQVNDLElBQVQsR0FBa0IseUJBQy9CLEtBQU0sQ0FBQ0MsS0FBRCxDQUFRQyxLQUFSLENBQWVDLFdBQWYsQ0FBNEJDLFFBQTVCLDJCQUF5Q0osSUFBekMsQ0FBTixDQUVBLEdBQUlLLENBQUFBLE1BQUosQ0FDQSxHQUFJQyxDQUFBQSxNQUFKLENBSitCLHdCQU0vQmhCLFFBQVEsQ0FBQ2lCLE1BQVQsQ0FBZ0JSLE1BQWhCLENBQXdCLFFBQXhCLEVBTitCLHdCQU8vQixH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QWhDLENBQTVELENBQVosQ0FBUCxDQUNILENBQ0osQ0F0Q0UsRUF1Q0ZLLElBdkNFLENBdUNHLElBQU0seUJBQUUsQ0F2Q1gsQ0FBUCxDQXdDSCxDQTdERCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgdmFsaWRhdGUgfSA9IHJlcXVpcmUoJy4uLy4uL3NoYXJlLW15LXNwb3QtdXRpbHMnKVxuY29uc3QgeyBtb2RlbHM6IHsgVXNlciB9IH0gPSByZXF1aXJlKCcuLi8uLi9zaGFyZS1teS1zcG90LWRhdGEnKVxuY29uc3QgeyBOb3RGb3VuZEVycm9yLCBOb3RBbGxvd2VkRXJyb3IgfSA9IHJlcXVpcmUoJy4uLy4uL3NoYXJlLW15LXNwb3QtZXJyb3JzJylcbmNvbnN0IGJjcnlwdCA9IHJlcXVpcmUoJ2JjcnlwdGpzJylcblxubW9kdWxlLmV4cG9ydHMgPSAodXNlcklkLCBib2R5KSA9PiB7XG4gICAgY29uc3Qge2VtYWlsLCBwaG9uZSwgb2xkUGFzc3dvcmQsIHBhc3N3b3JkfSA9ICBib2R5XG5cbiAgICBsZXQgZW1haWxfXG4gICAgbGV0IHBob25lX1xuXG4gICAgdmFsaWRhdGUuc3RyaW5nKHVzZXJJZCwgJ3VzZXJJZCcpXG4gICAgaWYgKGVtYWlsKXtcbiAgICAgICAgdmFsaWRhdGUuc3RyaW5nKGVtYWlsLCAnZW1haWwnKVxuICAgICAgICB2YWxpZGF0ZS5lbWFpbChlbWFpbClcbiAgICAgICAgZW1haWxfID0gZW1haWxcbiAgICB9XG4gICAgaWYgKHBob25lKXtcbiAgICAgICAgdmFsaWRhdGUudHlwZShwaG9uZSwgJ3Bob25lJywgTnVtYmVyKVxuICAgICAgICBwaG9uZV8gPSBwaG9uZVxuICAgIH1cbiAgICBpZiAob2xkUGFzc3dvcmQgJiYgcGFzc3dvcmQpe1xuICAgICAgICB2YWxpZGF0ZS5zdHJpbmcob2xkUGFzc3dvcmQsICdvbGRQYXNzd29yZCcpXG4gICAgICAgIHZhbGlkYXRlLnN0cmluZyhwYXNzd29yZCwgJ3Bhc3N3b3JkJylcbiAgICB9XG5cbiAgICByZXR1cm4gVXNlci5maW5kT25lKHtlbWFpbH0pXG4gICAgICAgIC50aGVuKGluY29ycmVjdCA9PntcbiAgICAgICAgICAgIGlmIChpbmNvcnJlY3QpIHRocm93IG5ldyBOb3RBbGxvd2VkRXJyb3IoJ1RoaXMgZW1haWwgaXMgYWxyZWFkeSBpbiB1c2UuJylcbiAgICAgICAgICAgIHJldHVybiBVc2VyLmZpbmRCeUlkKHVzZXJJZClcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4odXNlciA9PiB7XG4gICAgICAgICAgICBpZiAoIWVtYWlsKXtcbiAgICAgICAgICAgICAgICBlbWFpbF8gPSB1c2VyLmVtYWlsXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXBob25lKXtcbiAgICAgICAgICAgICAgICBwaG9uZV8gPSB1c2VyLnBob25lXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodXNlcikge1xuICAgICAgICAgICAgICAgIGlmIChvbGRQYXNzd29yZCl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBiY3J5cHQuY29tcGFyZShvbGRQYXNzd29yZCwgdXNlci5wYXNzd29yZClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcignVGhpcyB1c2VyIGNhbm5vdCBjaGFuZ2UgdGhlIGRhdGEnKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAudGhlbigoY29ycmVjdCkgPT4ge1xuICAgICAgICAgICAgaWYgKGNvcnJlY3QgJiYgb2xkUGFzc3dvcmQpe1xuICAgICAgICAgICAgICAgIHJldHVybiBiY3J5cHQuaGFzaChwYXNzd29yZCwgMTApXG5cbiAgICAgICAgICAgIH1pZiAob2xkUGFzc3dvcmQpe1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBOb3RBbGxvd2VkRXJyb3IoJ09sZCBwYXNzd29yZCBpbmNvcnJlY3QnKVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9ICAgIFxuICAgICAgICB9KVxuICAgICAgICAudGhlbihuUGFzc3dvcmQgPT4ge1xuICAgICAgICAgICAgaWYgKG5QYXNzd29yZCl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFVzZXIuZmluZEJ5SWRBbmRVcGRhdGUodXNlcklkICwgeyAkc2V0OiB7ZW1haWw6IGVtYWlsXywgcGhvbmU6IHBob25lXywgcGFzc3dvcmQ6IG5QYXNzd29yZH19KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1VzZXIuZmluZEJ5SWRBbmRVcGRhdGUodXNlcklkICwgeyAkc2V0OiB7ZW1haWw6IGVtYWlsX319KSwgVXNlci5maW5kQnlJZEFuZFVwZGF0ZSh1c2VySWQgLCB7ICRzZXQ6IHtwaG9uZTogcGhvbmVffX0pXSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oKCkgPT4ge30pXG59Il19